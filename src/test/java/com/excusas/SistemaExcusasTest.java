package com.excusas;

import com.excusas.empleados.Empleado;
import com.excusas.empleados.encargados.*;
import com.excusas.empleados.encargados.estrategias.ModoNormal;
import com.excusas.empleados.encargados.estrategias.ModoProductivo;
import com.excusas.empleados.encargados.estrategias.ModoVago;
import com.excusas.excusas.*;
import com.excusas.excusas.complejas.ExcusaCompleja;
import com.excusas.excusas.inverosimiles.ExcusaInverosimil;
import com.excusas.excusas.moderadas.ExcusaModerada;
import com.excusas.excusas.triviales.ExcusaTrivial;
import com.excusas.mail.EmailSender;
import com.excusas.mail.EmailSenderImpl;
import com.excusas.prontuario.AdministradorProntuarios;
import com.excusas.prontuario.Observer;
import com.excusas.prontuario.Prontuario;
import com.excusas.excepciones.ErrorConfiguracion;
import com.excusas.excepciones.ErrorProcesamiento;
import com.excusas.sistema.SistemaExcusas;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;

@DisplayName("‚ñ∂Ô∏è Pruebas del Sistema de Gesti√≥n de Excusas")
@ExtendWith(MockitoExtension.class)
public class SistemaExcusasTest {

    @Mock
    private EmailSender emailSender;


    @Nested
    @DisplayName("üìÑ Pruebas de Creaci√≥n de Excusas")
    class ExcusasTest {
        private Empleado empleado;

        @BeforeEach
        void setUp() {
            empleado = new Empleado("Test User", "test@empresa.com", 3001);
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a crear una Excusa Trivial con un motivo v√°lido")
        void deberiaCrearExcusaTrivialConMotivoValido() {
            ExcusaTrivial excusa = new ExcusaTrivial(empleado, MotivoExcusa.QUEDARSE_DORMIDO);
            assertEquals("TRIVIAL", excusa.getTipo());
            assertEquals(MotivoExcusa.QUEDARSE_DORMIDO, excusa.getMotivo());
            assertEquals(empleado, excusa.getEmpleado());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar excepci√≥n al crear Excusa Trivial con motivo inv√°lido")
        void deberiaLanzarExcepcionConMotivoInvalidoParaTrivial() {
            assertThrows(IllegalArgumentException.class, () -> new ExcusaTrivial(empleado, MotivoExcusa.IRRELEVANTE));
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a crear una Excusa Moderada con un motivo v√°lido")
        void deberiaCrearExcusaModeradaConMotivoValido() {
            ExcusaModerada excusa = new ExcusaModerada(empleado, MotivoExcusa.PERDIDA_SUMINISTRO);
            assertEquals("MODERADA", excusa.getTipo());
            assertEquals(MotivoExcusa.PERDIDA_SUMINISTRO, excusa.getMotivo());
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a crear una Excusa Compleja con un motivo v√°lido")
        void deberiaCrearExcusaComplejaConMotivoValido() {
            ExcusaCompleja excusa = new ExcusaCompleja(empleado, MotivoExcusa.IRRELEVANTE);
            assertEquals("COMPLEJA", excusa.getTipo());
            assertEquals(MotivoExcusa.IRRELEVANTE, excusa.getMotivo());
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a crear una Excusa Inveros√≠mil con un motivo v√°lido")
        void deberiaCrearExcusaInverosimilConMotivoValido() {
            ExcusaInverosimil excusa = new ExcusaInverosimil(empleado, MotivoExcusa.INCREIBLE_INVEROSIMIL);
            assertEquals("INVEROSIMIL", excusa.getTipo());
            assertEquals(MotivoExcusa.INCREIBLE_INVEROSIMIL, excusa.getMotivo());
        }
    }

    // --- CHAIN OF RESPONSABILITY ---
    @Nested
    @DisplayName("üîó Pruebas de Cadena de Responsabilidad (Chain of Responsibility)")
    class ChainOfResponsibilityTest {
        private Recepcionista recepcionista;
        private ManejadorExcusas siguienteEncargado;

        @BeforeEach
        void setUp() {
            siguienteEncargado = mock(ManejadorExcusas.class);
            recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, new ModoNormal(), emailSender);
            recepcionista.setSiguiente(siguienteEncargado);
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a procesar la excusa que puede manejar y no pasarla al siguiente")
        void deberiaProcesarExcusaQueManeja() {
            Empleado empleado = new Empleado("Juan", "juan@empresa.com", 2001);
            ExcusaTrivial excusa = new ExcusaTrivial(empleado, MotivoExcusa.QUEDARSE_DORMIDO);

            recepcionista.manejarExcusa(excusa);

            verify(emailSender).enviarEmail("juan@empresa.com", "ana@excusas.com", "motivo demora", "la licencia fue aceptada");
            verify(siguienteEncargado, never()).manejarExcusa(any());
        }

        @Test
        @DisplayName("‚û°Ô∏è Deber√≠a pasar la excusa al siguiente encargado si no puede manejarla")
        void deberiaPasarExcusaQueNoManeja() {
            Excusa excusaNoTrivial = mock(Excusa.class);
            when(excusaNoTrivial.getTipo()).thenReturn("MODERADA");

            recepcionista.manejarExcusa(excusaNoTrivial);

            verify(siguienteEncargado).manejarExcusa(excusaNoTrivial);
            verifyNoInteractions(emailSender);
        }

        @Test
        @DisplayName("üëç Deber√≠a crear una cadena de encargados correctamente")
        void deberiaCrearCadenaCorrectamente() {
            LineaEncargados linea = new LineaEncargados();
            Recepcionista recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, new ModoNormal(), emailSender);
            SupervisorArea supervisor = new SupervisorArea("Carlos", "carlos@excusas.com", 1002, new ModoNormal(), emailSender);

            linea.crearCadena(recepcionista, supervisor);

            assertNotNull(linea.getPrimerEncargado());
            assertEquals(recepcionista, linea.getPrimerEncargado());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorConfiguracion si la cadena se intenta crear vac√≠a")
        void deberiaLanzarExcepcionConCadenaVacia() {
            LineaEncargados linea = new LineaEncargados();
            // CORRECCI√ìN: Se esperaba ErrorConfiguracion, no IllegalArgumentException.
            assertThrows(ErrorConfiguracion.class, linea::crearCadena);
        }
    }

    // --- STRATEGY ---
    @Nested
    @DisplayName("‚ôüÔ∏è Pruebas de Estrategias de Resoluci√≥n (Strategy)")
    class StrategyTest {
        private Empleado empleado;
        private ExcusaTrivial excusa;

        @BeforeEach
        void setUp() {
            empleado = new Empleado("Test User", "test@empresa.com", 1001);
            excusa = new ExcusaTrivial(empleado, MotivoExcusa.QUEDARSE_DORMIDO);
        }

        @Test
        @DisplayName("üòê Modo Normal: Deber√≠a evaluar y procesar sin acciones extra")
        void modoNormalDeberiaEvaluarYNoHacerAccionAdicional() {
            ModoNormal modo = new ModoNormal();
            Recepcionista recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, modo, emailSender);

            recepcionista.manejarExcusa(excusa);

            verify(emailSender).enviarEmail("test@empresa.com", "ana@excusas.com", "motivo demora", "la licencia fue aceptada");
            verify(emailSender, never()).enviarEmail(eq("cto@excusas.com"), anyString(), anyString(), anyString());
        }

        @Test
        @DisplayName("üò¥ Modo Vago: No deber√≠a evaluar y pasar la excusa al siguiente")
        void modoVagoNoDeberiaEvaluar() {
            ModoVago modo = new ModoVago();
            Recepcionista recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, modo, emailSender);
            var siguienteEncargado = mock(ManejadorExcusas.class);
            recepcionista.setSiguiente(siguienteEncargado);

            recepcionista.manejarExcusa(excusa);

            verify(siguienteEncargado).manejarExcusa(excusa);
            verifyNoInteractions(emailSender);
        }

        @Test
        @DisplayName("üöÄ Modo Productivo: Deber√≠a procesar y notificar al CTO")
        void modoProductivoDeberiaNotificarCTO() {
            ModoProductivo modo = new ModoProductivo();
            Recepcionista recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, modo, emailSender);

            recepcionista.manejarExcusa(excusa);

            verify(emailSender).enviarEmail("test@empresa.com", "ana@excusas.com", "motivo demora", "la licencia fue aceptada");
            verify(emailSender).enviarEmail("cto@excusas.com", "sistema@excusas.com", "Notificaci√≥n de Procesamiento", "Se est√° procesando una excusa en modo productivo para el empleado: Test User");
        }
    }

    // --- OBSERVER/SINGLETON---
    @Nested
    @DisplayName("üì¶ Pruebas de Prontuarios (Observer y Singleton)")
    class ObserverYSingletonTest {
        private AdministradorProntuarios administrador;
        private Observer observerMock;
        private Empleado empleado;
        private CEO ceo;

        @BeforeEach
        void setUp() {
            AdministradorProntuarios.reset(); // Limpia el estado del Singleton para cada prueba
            administrador = AdministradorProntuarios.getInstance();
            observerMock = mock(Observer.class);
            empleado = new Empleado("Test User", "test@empresa.com", 3001);
            ceo = new CEO("Roberto Silva", "roberto@excusas.com", 1004, new ModoNormal(), emailSender);
        }

        @AfterEach
        void tearDown() {
            AdministradorProntuarios.reset();
        }

        @Test
        @DisplayName("‚òùÔ∏è Deber√≠a devolver siempre la misma instancia (Singleton)")
        void deberiaSerSingleton() {
            AdministradorProntuarios otraInstancia = AdministradorProntuarios.getInstance();
            assertSame(administrador, otraInstancia);
        }

        @Test
        @DisplayName("üì• Deber√≠a guardar un prontuario correctamente")
        void deberiaGuardarProntuario() {
            Prontuario prontuario = new Prontuario(empleado, mock(Excusa.class), empleado.getLegajo());
            administrador.guardarProntuario(prontuario);
            assertEquals(1, administrador.getProntuarios().size());
            assertSame(prontuario, administrador.getProntuarios().get(0));
        }

        @Test
        @DisplayName("üîî Deber√≠a notificar a los observers al guardar un prontuario")
        void deberiaNotificarObservers() {
            administrador.agregarObserver(observerMock);
            Prontuario prontuario = new Prontuario(empleado, mock(Excusa.class), empleado.getLegajo());
            administrador.guardarProntuario(prontuario);
            verify(observerMock).notificar(prontuario);
        }

        @Test
        @DisplayName("üóëÔ∏è Deber√≠a permitir quitar observers para que no reciban notificaciones")
        void deberiaPermitirQuitarObservers() {
            administrador.agregarObserver(observerMock);
            administrador.quitarObserver(observerMock);
            Prontuario prontuario = new Prontuario(empleado, mock(Excusa.class), empleado.getLegajo());
            administrador.guardarProntuario(prontuario);
            verify(observerMock, never()).notificar(any());
        }

        @Test
        @DisplayName("üëë El CEO deber√≠a procesar una excusa inveros√≠mil y crear un prontuario")
        void deberiaProcesarExcusaInverosimil() {
            ExcusaInverosimil excusa = new ExcusaInverosimil(empleado, MotivoExcusa.INCREIBLE_INVEROSIMIL);

            ceo.manejarExcusa(excusa);

            verify(emailSender).enviarEmail("test@empresa.com", "roberto@excusas.com", "Excusa Aprobada", "Aprobado por creatividad");
            assertEquals(1, administrador.getProntuarios().size());
            assertEquals(empleado, administrador.getProntuarios().get(0).getEmpleado());
        }

        @Test
        @DisplayName("üó£Ô∏è El CEO deber√≠a notificar a otros observers (otros CEOs) al crear un prontuario")
        void deberiaNotificarAOtrosCEOs() {
            Observer otroCEO = mock(Observer.class);
            administrador.agregarObserver(otroCEO);
            ExcusaInverosimil excusa = new ExcusaInverosimil(empleado, MotivoExcusa.INCREIBLE_INVEROSIMIL);

            ceo.manejarExcusa(excusa);

            verify(otroCEO).notificar(any(Prontuario.class));
        }
    }


    @Nested
    @DisplayName("‚öôÔ∏è Pruebas de Integraci√≥n del Flujo Completo")
    class IntegracionTest {
        private LineaEncargados linea;
        private Empleado empleadoTrivial, empleadoModerado, empleadoComplejo, empleadoInverosimil;

        @BeforeEach
        void setUp() {
            AdministradorProntuarios.reset();

            Recepcionista recepcionista = new Recepcionista("Ana Garc√≠a", "ana@excusas.com", 1001, new ModoNormal(), emailSender);
            SupervisorArea supervisor = new SupervisorArea("Carlos L√≥pez", "carlos@excusas.com", 1002, new ModoProductivo(), emailSender);
            GerenteRRHH gerente = new GerenteRRHH("Mar√≠a Rodr√≠guez", "maria@excusas.com", 1003, new ModoNormal(), emailSender);
            CEO ceo = new CEO("Roberto Silva", "roberto@excusas.com", 1004, new ModoNormal(), emailSender);

            linea = new LineaEncargados();
            linea.crearCadena(recepcionista, supervisor, gerente, ceo);

            empleadoTrivial = new Empleado("Juan P√©rez", "juan@empresa.com", 2001);
            empleadoModerado = new Empleado("Ana Torres", "ana.torres@empresa.com", 2002);
            empleadoComplejo = new Empleado("Luis Mart√≠n", "luis@empresa.com", 2005);
            empleadoInverosimil = new Empleado("Sofia Ruiz", "sofia@empresa.com", 2004);
        }

        @Test
        @DisplayName("‚û°Ô∏è Recepcionista deber√≠a manejar una excusa TRIVIAL")
        void deberiaProcesarExcusaTrivialConRecepcionista() {
            ExcusaTrivial excusa = new ExcusaTrivial(empleadoTrivial, MotivoExcusa.QUEDARSE_DORMIDO);
            linea.getPrimerEncargado().manejarExcusa(excusa);
            verify(emailSender).enviarEmail("juan@empresa.com", "ana@excusas.com", "motivo demora", "la licencia fue aceptada");
            verify(emailSender, never()).enviarEmail(eq("EDESUR@mailfake.com.ar"), anyString(), anyString(), anyString());
        }

        @Test
        @DisplayName("‚û°Ô∏è Supervisor deber√≠a manejar una excusa MODERADA")
        void deberiaProcesarExcusaModeradaConSupervisor() {
            ExcusaModerada excusa = new ExcusaModerada(empleadoModerado, MotivoExcusa.PERDIDA_SUMINISTRO);
            linea.getPrimerEncargado().manejarExcusa(excusa);
            verify(emailSender).enviarEmail("cto@excusas.com", "sistema@excusas.com", "Notificaci√≥n de Procesamiento", "Se est√° procesando una excusa en modo productivo para el empleado: Ana Torres");
            verify(emailSender).enviarEmail("EDESUR@mailfake.com.ar", "carlos@excusas.com", "Consulta sobre corte de suministro", "Consulta si hubo corte de suministro en la zona del empleado Ana Torres");
        }

        @Test
        @DisplayName("‚û°Ô∏è Gerente de RRHH deber√≠a manejar una excusa COMPLEJA")
        void deberiaProcesarExcusaComplejaConGerente() {
            ExcusaCompleja excusa = new ExcusaCompleja(empleadoComplejo, MotivoExcusa.IRRELEVANTE);
            linea.getPrimerEncargado().manejarExcusa(excusa);
            verify(emailSender).enviarEmail("cto@excusas.com", "sistema@excusas.com", "Notificaci√≥n de Procesamiento", "Se est√° procesando una excusa en modo productivo para el empleado: Luis Mart√≠n");
            verify(emailSender, never()).enviarEmail(eq(empleadoComplejo.getEmail()), anyString(), anyString(), anyString());
        }

        @Test
        @DisplayName("‚û°Ô∏è CEO deber√≠a manejar una excusa INVEROSIMIL")
        void deberiaProcesarExcusaInverosimilConCEO() {
            ExcusaInverosimil excusa = new ExcusaInverosimil(empleadoInverosimil, MotivoExcusa.INCREIBLE_INVEROSIMIL);
            linea.getPrimerEncargado().manejarExcusa(excusa);
            verify(emailSender).enviarEmail("cto@excusas.com", "sistema@excusas.com", "Notificaci√≥n de Procesamiento", "Se est√° procesando una excusa en modo productivo para el empleado: Sofia Ruiz");
            verify(emailSender).enviarEmail("sofia@empresa.com", "roberto@excusas.com", "Excusa Aprobada", "Aprobado por creatividad");
            assertEquals(1, AdministradorProntuarios.getInstance().getProntuarios().size());
        }

        @Test
        @DisplayName("üõë El Rechazador deber√≠a manejar una excusa no reconocida por nadie")
        void deberiaRechazarExcusaNoManejable() {

            Excusa excusaInvalida = mock(Excusa.class);
            when(excusaInvalida.getTipo()).thenReturn("TIPO_INEXISTENTE");
            when(excusaInvalida.getEmpleado()).thenReturn(new Empleado("Test", "test@test.com", 1));

            linea.getPrimerEncargado().manejarExcusa(excusaInvalida);


            verify(emailSender).enviarEmail(eq("cto@excusas.com"), anyString(), anyString(), anyString());

            verify(emailSender, never()).enviarEmail(eq("test@test.com"), anyString(), anyString(), anyString());
        }
    }


    @Nested
    @DisplayName("üí£ Pruebas de Excepciones Personalizadas")
    class ExcepcionesTest {

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorConfiguracion con cadena de encargados vac√≠a")
        void deberiaLanzarErrorConfiguracionConCadenaVacia() {
            LineaEncargados linea = new LineaEncargados();
            ErrorConfiguracion exception = assertThrows(ErrorConfiguracion.class, linea::crearCadena);
            assertEquals("La cadena de encargados no puede estar vac√≠a", exception.getMessage());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorConfiguracion con un encargado nulo en la cadena")
        void deberiaLanzarErrorConfiguracionConEncargadoNulo() {
            LineaEncargados linea = new LineaEncargados();
            Recepcionista recepcionista = new Recepcionista("Ana", "ana@excusas.com", 1001, new ModoNormal(), emailSender);
            ErrorConfiguracion exception = assertThrows(ErrorConfiguracion.class, () -> linea.crearCadena(recepcionista, null));
            assertEquals("El encargado en la posici√≥n 1 no puede ser nulo", exception.getMessage());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorProcesamiento al guardar un prontuario nulo")
        void deberiaLanzarErrorProcesamientoConProntuarioNulo() {
            AdministradorProntuarios admin = AdministradorProntuarios.getInstance();
            ErrorProcesamiento exception = assertThrows(ErrorProcesamiento.class, () -> admin.guardarProntuario(null));
            assertEquals("No se puede guardar un prontuario nulo", exception.getMessage());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorProcesamiento con formato de email inv√°lido")
        void deberiaLanzarErrorProcesamientoConEmailInvalido() {
            EmailSenderImpl realEmailSender = new EmailSenderImpl();
            ErrorProcesamiento exception = assertThrows(ErrorProcesamiento.class, () -> realEmailSender.enviarEmail("email-invalido", "origen@test.com", "Asunto", "Cuerpo"));
            assertTrue(exception.getMessage().contains("El email de destino no tiene un formato v√°lido"));
        }
    }


    @Nested
    @DisplayName("üöÄ Pruebas de la clase principal SistemaExcusas")
    class SistemaExcusasIntegracionTest {
        private SistemaExcusas sistema;

        @BeforeEach
        void setUp() {
            AdministradorProntuarios.reset();
            sistema = new SistemaExcusas();
        }

        @Test
        @DisplayName("‚úÖ Deber√≠a inicializar el sistema correctamente")
        void deberiaInicializarCorrectamente() {
            sistema.inicializar();
            assertTrue(sistema.estaInicializado());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorConfiguracion si se procesa una excusa sin inicializar")
        void deberiaLanzarErrorConfiguracionSinInicializar() {
            Empleado empleado = new Empleado("Test", "test@empresa.com", 1001);
            ExcusaTrivial excusa = new ExcusaTrivial(empleado, MotivoExcusa.QUEDARSE_DORMIDO);
            ErrorConfiguracion exception = assertThrows(ErrorConfiguracion.class, () -> sistema.procesarExcusa(excusa));
            assertEquals("El sistema no ha sido inicializado", exception.getMessage());
        }

        @Test
        @DisplayName("‚ùå Deber√≠a lanzar ErrorProcesamiento si la excusa a procesar es nula")
        void deberiaLanzarErrorProcesamientoConExcusaNula() {
            sistema.inicializar();
            ErrorProcesamiento exception = assertThrows(ErrorProcesamiento.class, () -> sistema.procesarExcusa(null));
            assertEquals("No se puede procesar una excusa nula", exception.getMessage());
        }

        @Test
        @DisplayName("üëç Deber√≠a procesar una excusa sin lanzar excepciones despu√©s de inicializar")
        void deberiaProcesarExcusaCorrectamente() {
            sistema.inicializar();
            Empleado empleado = new Empleado("Juan", "juan@empresa.com", 2001);
            ExcusaTrivial excusa = new ExcusaTrivial(empleado, MotivoExcusa.QUEDARSE_DORMIDO);
            assertDoesNotThrow(() -> sistema.procesarExcusa(excusa));
        }
    }
}